



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>RECAST3D - RECAST3D</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#recast3d" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="RECAST3D" aria-label="RECAST3D" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            RECAST3D
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/cicwi/RECAST3D/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    cicwi/RECAST3D
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="RECAST3D" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    RECAST3D
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/cicwi/RECAST3D/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    cicwi/RECAST3D
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../installation_instructions/" title="Installing" class="md-nav__link">
      Installing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      User Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/live_scan/" title="Running the stack" class="md-nav__link">
      Running the stack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/interface/" title="Interface" class="md-nav__link">
      Interface
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/adapters/" title="Data adapters" class="md-nav__link">
      Data adapters
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/plugins/" title="Plugins" class="md-nav__link">
      Plugins
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Contributor Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Contributor Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../design/" title="Design" class="md-nav__link">
      Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tomopackets/" title="TomoPackets" class="md-nav__link">
      TomoPackets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../slicerecon/" title="SliceRecon" class="md-nav__link">
      SliceRecon
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        RECAST3D
      </label>
    
    <a href="./" title="RECAST3D" class="md-nav__link md-nav__link--active">
      RECAST3D
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#graphics-and-scenes" class="md-nav__link">
    Graphics and scenes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ui-elements" class="md-nav__link">
    UI elements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server" class="md-nav__link">
    Server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-reconstruction-of-a-re-oriented-slice" class="md-nav__link">
    Example: Reconstruction of a re-oriented slice
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-extend-recast3d-to-add-control-parameters" class="md-nav__link">
    Example: Extend RECAST3D to add control parameters
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../changelog/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#graphics-and-scenes" class="md-nav__link">
    Graphics and scenes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ui-elements" class="md-nav__link">
    UI elements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server" class="md-nav__link">
    Server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-reconstruction-of-a-re-oriented-slice" class="md-nav__link">
    Example: Reconstruction of a re-oriented slice
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-extend-recast3d-to-add-control-parameters" class="md-nav__link">
    Example: Extend RECAST3D to add control parameters
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/cicwi/RECAST3D/edit/master/docs/contribute/recast3d.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="recast3d">RECAST3D</h1>
<p>RECAST3D is based on TomoPackets (ZeroMQ) for communication and OpenGL for visualization. It runs a single <em>server</em>, which communicates with a reconstruction server such as SliceRecon.</p>
<p>First, a brief summary of the RECAST3D design. The slicer environment is implemented in <code>ReconstructionComponent</code>, but there is much more in RECAST3D. It has a flexible and transparent server that distributes TomoPackets to modules that want to know about them. Using graphics components and modules, it is easy to extend, improve, or change behaviour. The rendering is based on OpenGL, making it flexible but not trivial to extend. I provide texture, shader, meshes and primitive support, which makes it easier to make a new component. The immediate mode user interface is straightforward to use.</p>
<h2 id="graphics-and-scenes">Graphics and scenes</h2>
<p>The software can have multiple scenes. Each scene corresponds to the visualization of a single scan.</p>
<p>The important classes that realize the graphics are organized as follows:</p>
<div class="mermaid">
    classDiagram
      class AxesComponent
      class GeometryComponent
      class MeshComponent
      class ReconstructionComponent
      class Component {
          identifier
          draw()
          tick()
          describe()
      }
      class SceneObject {
        camera
        graphics resources
      }
      class Scene {
        name
        dimension
        data
      }

      AxesComponent <|-- Component
      GeometryComponent <|-- Component
      MeshComponent <|-- Component
      ReconstructionComponent <|-- Component

      SceneObject <|-- Scene : Contains
      Component <|-- SceneObject : Contains
</div>

<p>The graphics are rendered directly using OpenGL, but there are helper classes available (for primitives, shader programs, textures, and so on).</p>
<p>Important shared interfaces for many classes in the graphics implementations are:</p>
<div class="mermaid">
classDiagram
  class RenderTarget {
     render(...) 
  }
  class Ticker {
     tick(time_elapsed) 
  }
  class Window {
     describe()
  }
  class PacketPublisher {
    send(packet)
    add_listener(...)
  }
  class PacketListener {
    handle(packet)
  }
  PacketPublisher <|-- PacketListener
</div>

<ul>
<li><code>RenderTarget</code> is for any component that wants to be rendered, such as a scene or the user interface. A scene eventually calls <code>draw</code> on its components which takes into account the (3D) camera.</li>
<li><code>Ticker</code> is implemented by any object that wants to update itself over regular time intervals.</li>
<li><code>Window</code> is implemented by any object that wants to add controls to the user interface</li>
<li><code>PacketPublisher</code> and <code>PacketListener</code> allows to easily send packets to upstream components of the reconstruction stack from any point in the graphics (for example, as a side effect due to user input).</li>
</ul>
<h2 id="ui-elements">UI elements</h2>
<p>We use <a href="https://github.com/ocornut/imgui/tree/master/docs">ImGui</a> for the user interface. This allows parts of the graphics stack to easily draw check boxes, sliders, and text input. This is done through the <code>Window</code> interface.</p>
<p>There is also built in support for parameters of upstream components, using the <code>ParameterX</code> packets of TomoPackets.</p>
<h2 id="server">Server</h2>
<p>The server has a number of &lsquo;modules&rsquo;. Each module corresponds to a part of RECAST3D that is interested in handling certain packages. A selection of the implemented modules:</p>
<div class="mermaid">
classDiagram
  class SceneModuleProtocol {
     read_packet(...) 
     process(...)
     descriptors(...)
  }

   ManageSceneProtocol <|-- SceneModuleProtocol
   ReconstructionProtocol <|-- SceneModuleProtocol
   GeometryProtocol <|-- SceneModuleProtocol
   ControlProtocol <|-- SceneModuleProtocol
</div>

<p>For example, the manage scene protocol listens only to incoming packets of type <code>MakeScenePacket</code>, and whenever one comes in it adds a scene to the scene list. Something to note is that <code>read_packet</code> happens on the server thread, while <code>process</code> happens on the graphics thead. These are kept separate so that all OpenGL calls happen from within a single thread.</p>
<p>There is a server running the ZeroMQ <code>REP/REQ</code> protocol that handles incoming packets from upstream (by default on port 5555), and a thread running a <code>PUB/SUB</code> protocol that publishes outgoing packets to (multiple) listeners (by default on port 5556).</p>
<h2 id="example-reconstruction-of-a-re-oriented-slice"><em>Example</em>: Reconstruction of a re-oriented slice</h2>
<p>Let us explore in detail what happens when the user changes a slice. This happens when the user translates along the normal of a slice (using the left mouse button), or rotates around the furthest edge from where they click (using the right button).</p>
<p><code>ReconstructionComponent</code> optionally has a <code>ReconDragMachine</code> which is initiated as soon as the user clicks on the mouse. There are two kinds: a <code>SliceTranslator</code> and a <code>SliceRotator</code>, which both have an <code>on_drag</code> event.</p>
<div class="mermaid">
stateDiagram
    Idle --> Translating : left_mouse_down
    Translating --> Idle : left_mouse_up
    state Translating {
      [*] --> [*] : mouse_drag
    }
    Idle --> Rotating : right_mouse_down
    Rotating --> Idle : right_mouse_up
    state Rotating {
      [*] --> [*] : mouse_drag
    }
</div>

<p>These machines actually deactivate a slice upon creation, and have a reference to a &lsquo;ghost&rsquo; slice that is will be created when the mouse is released.</p>
<p>When this new slice is created, we have to let the reconstruction server now that this has occured. A <code>SetSlicePacket</code> is created using the orientation of the newly created slice, and published using the <code>PUB/SUB</code> servers to upstream clients that are subscribed to this packets. For example, SliceRecon registers to this packet.</p>
<div class="mermaid">
sequenceDiagram
    participant Component
    participant SliceRecon
    participant Protocol
    Component->>SliceRecon: SetSlicePacket
    SliceRecon->>Protocol: SliceDataPacket
    Protocol->>Component: set_data(...)
</div>

<p>The reconstruction server then computes a slice reconstruction for the slice, and sends this to the incoming port of RECAST3D (the <code>REQ/REP</code> server). This is eventually handled by the <code>ReconstructionProtocol</code> that listens to <code>SliceDataPackets</code>. When this protocol handles the request, it updates the data of the corresponding scene, and this is ultimately reflected  in the ReconstructionComponent which then shows the updated slice.</p>
<p>Note that this entire sequence happens within milliseconds, and is entirely distributed: RECAST3D and the reconstruction server do not have to run on the same computer, and in fact any agent can act as the reconstruction server.</p>
<h2 id="example-extend-recast3d-to-add-control-parameters"><em>Example</em>: Extend RECAST3D to add control parameters</h2>
<p>As an example of a feature that was added to RECAST3D, let&rsquo;s discuss the steps it took to add control parameters to RECAST3D. The idea of control parameters is that upstream components can register a &lsquo;parameter&rsquo; with RECAST3D, which then shows a UI element to change this parameter. When the user changes one of these parameters using the UI, a packet has to be sent to the upstream component that it belongs to.</p>
<ol>
<li>Control packets were added to TomoPackets (e.g. <code>ParameterBoolPacket</code>)</li>
<li>A <code>ControlComponent</code> and a <code>ControlModule</code> were added to RECAST3D. Note that the control component does not draw anything in the 3D window, but only wants to add additional UI elements.</li>
<li>The <code>ControlModule</code> registers itself as the handler for e.g. the <code>ParameterBoolPacket</code> and others (actual implementation also includes benchmarking, and tracking).</li>
<li>When a <code>ParameterBoolPacket</code> is received by the module it gets sent to the appropriate <code>ControlComponent</code>. </li>
<li>The implementation of the <code>ControlComponent</code>:<ul>
<li>In <code>describe()</code>, for drawing UI elements: one checkbox for each known parameter.</li>
<li>If checkbox changed by user, we send a <code>ParameterBoolPacket</code> downstream.</li>
</ul>
</li>
</ol>
<p>After these changes, we can use this for real-time alignment parameter adjustment, changing filters, and so on, all without touching existing code in RECAST3D.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../slicerecon/" title="SliceRecon" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                SliceRecon
              </span>
            </div>
          </a>
        
        
          <a href="../../changelog/" title="Release Notes" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Release Notes
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            RECAST3D is licensed under the <a href='https://github.com/cicwi/RECAST3D/blob/master/LICENSE.md'>GPL license</a>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:"../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
        <script src="https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js"></script>
      
    
  </body>
</html>