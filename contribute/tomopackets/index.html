



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>TomoPackets - RECAST3D</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#pipeline" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="RECAST3D" aria-label="RECAST3D" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              RECAST3D
            </span>
            <span class="md-header-nav__topic">
              
                TomoPackets
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/cicwi/RECAST3D/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    cicwi/RECAST3D
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="RECAST3D" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    RECAST3D
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/cicwi/RECAST3D/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    cicwi/RECAST3D
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../installation_instructions/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      User Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/interface/" title="Interface" class="md-nav__link">
      Interface
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/live_scan/" title="Running the stack" class="md-nav__link">
      Running the stack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/adapters/" title="Data adapters" class="md-nav__link">
      Data adapters
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/plugins/" title="Plugins" class="md-nav__link">
      Plugins
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Contributor Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Contributor Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../design/" title="Design" class="md-nav__link">
      Design
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        TomoPackets
      </label>
    
    <a href="./" title="TomoPackets" class="md-nav__link md-nav__link--active">
      TomoPackets
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipeline" class="md-nav__link">
    Pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#packets" class="md-nav__link">
    Packets
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#descriptors" class="md-nav__link">
    Descriptors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-a-new-packet" class="md-nav__link">
    Defining a new packet
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#serialization" class="md-nav__link">
    Serialization
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarchy-of-packet-classes-implementation" class="md-nav__link">
    Hierarchy of packet classes / implementation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sending-and-receiving-packets" class="md-nav__link">
    Sending and receiving packets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adapter-to-reconstructor" class="md-nav__link">
    Adapter to Reconstructor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reconstructor-tofrom-visualizer" class="md-nav__link">
    Reconstructor to/from Visualizer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-uses" class="md-nav__link">
    Other uses
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conventions" class="md-nav__link">
    Conventions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-dimensional-arrays" class="md-nav__link">
    Multi-dimensional arrays
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slice-orientation" class="md-nav__link">
    Slice orientation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acquisition-geometries" class="md-nav__link">
    Acquisition geometries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#writing-a-reconstruction-node" class="md-nav__link">
    Writing a reconstruction node
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../slicerecon/" title="SliceRecon" class="md-nav__link">
      SliceRecon
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../recast3d/" title="RECAST3D" class="md-nav__link">
      RECAST3D
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../release_procedure/" title="Release procedure" class="md-nav__link">
      Release procedure
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../changelog/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipeline" class="md-nav__link">
    Pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#packets" class="md-nav__link">
    Packets
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#descriptors" class="md-nav__link">
    Descriptors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-a-new-packet" class="md-nav__link">
    Defining a new packet
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#serialization" class="md-nav__link">
    Serialization
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarchy-of-packet-classes-implementation" class="md-nav__link">
    Hierarchy of packet classes / implementation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sending-and-receiving-packets" class="md-nav__link">
    Sending and receiving packets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adapter-to-reconstructor" class="md-nav__link">
    Adapter to Reconstructor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reconstructor-tofrom-visualizer" class="md-nav__link">
    Reconstructor to/from Visualizer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-uses" class="md-nav__link">
    Other uses
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conventions" class="md-nav__link">
    Conventions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-dimensional-arrays" class="md-nav__link">
    Multi-dimensional arrays
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slice-orientation" class="md-nav__link">
    Slice orientation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acquisition-geometries" class="md-nav__link">
    Acquisition geometries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#writing-a-reconstruction-node" class="md-nav__link">
    Writing a reconstruction node
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/cicwi/RECAST3D/edit/master/docs/contribute/tomopackets.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>TomoPackets</h1>
                
                <p>This library implements a communication protocol for a distributed tomographic
reconstruction pipeline in which parameters used in the reconstruction can be
changed in real-time, taking effect on the running reconstruction code
immediately.</p>
<p>The protocol is based on the reconstruction of individual slices, for example
orthogonal planes, and is useful for situations where the projection data is to
big to reconstruct completely in real-time. The slices are shown together in a
3D interface, and get updated when, for example:</p>
<ul>
<li>new (projection) data is available</li>
<li>more iterations for iterative solvers have been applied</li>
<li>higher resolution reconstructions are available</li>
</ul>
<p>The position and orientation of the <em>active slices</em> can be changed, and this is
communicated back to the reconstruction cluster, which for future updates will
then reconstruct these new slices.</p>
<h2 id="pipeline">Pipeline</h2>
<p>For real-time imaging experiments, there are many nodes at work at the same
time. A rough overview of the topology that is recommended (but not required)
for communication based on TomoPackets is as follows.</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (0)
 -->
<!-- Title: G Pages: 1 -->
<svg width="202pt" height="404pt"
 viewBox="0.00 0.00 201.99 404.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 400)">
<title>G</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-400 197.9896,-400 197.9896,4 -4,4"/>
<!-- Scan Data -->
<g id="node1" class="node">
<title>Scan Data</title>
<ellipse fill="none" stroke="#000000" cx="76.6932" cy="-378" rx="57.6901" ry="18"/>
<text text-anchor="middle" x="76.6932" y="-374.3" font-family="Times,serif" font-size="14.00" fill="#000000">Scan Data</text>
</g>
<!-- Adapter -->
<g id="node2" class="node">
<title>Adapter</title>
<ellipse fill="none" stroke="#000000" cx="76.6932" cy="-306" rx="48.1917" ry="18"/>
<text text-anchor="middle" x="76.6932" y="-302.3" font-family="Times,serif" font-size="14.00" fill="#000000">Adapter</text>
</g>
<!-- Scan Data&#45;&gt;Adapter -->
<g id="edge1" class="edge">
<title>Scan Data&#45;&gt;Adapter</title>
<path fill="none" stroke="#000000" d="M76.6932,-359.8314C76.6932,-352.131 76.6932,-342.9743 76.6932,-334.4166"/>
<polygon fill="#000000" stroke="#000000" points="80.1933,-334.4132 76.6932,-324.4133 73.1933,-334.4133 80.1933,-334.4132"/>
</g>
<!-- Reconstructor -->
<g id="node3" class="node">
<title>Reconstructor</title>
<ellipse fill="none" stroke="#000000" cx="76.6932" cy="-234" rx="76.8869" ry="18"/>
<text text-anchor="middle" x="76.6932" y="-230.3" font-family="Times,serif" font-size="14.00" fill="#000000">Reconstructor</text>
</g>
<!-- Adapter&#45;&gt;Reconstructor -->
<g id="edge2" class="edge">
<title>Adapter&#45;&gt;Reconstructor</title>
<path fill="none" stroke="#000000" d="M76.6932,-287.8314C76.6932,-280.131 76.6932,-270.9743 76.6932,-262.4166"/>
<polygon fill="#000000" stroke="#000000" points="80.1933,-262.4132 76.6932,-252.4133 73.1933,-262.4133 80.1933,-262.4132"/>
</g>
<!-- Visualizer -->
<g id="node4" class="node">
<title>Visualizer</title>
<ellipse fill="none" stroke="#000000" cx="76.6932" cy="-18" rx="56.59" ry="18"/>
<text text-anchor="middle" x="76.6932" y="-14.3" font-family="Times,serif" font-size="14.00" fill="#000000">Visualizer</text>
</g>
<!-- Reconstructor&#45;&gt;Visualizer -->
<g id="edge3" class="edge">
<title>Reconstructor&#45;&gt;Visualizer</title>
<path fill="none" stroke="#000000" d="M72.7473,-215.9555C69.2888,-178.3144 69.0295,-91.1867 71.9693,-46.1246"/>
<polygon fill="#000000" stroke="#000000" points="75.4596,-46.3844 72.7381,-36.1451 68.4803,-45.8467 75.4596,-46.3844"/>
</g>
<!-- Plugin -->
<g id="node5" class="node">
<title>Plugin</title>
<ellipse fill="none" stroke="#000000" cx="153.6932" cy="-162" rx="40.0939" ry="18"/>
<text text-anchor="middle" x="153.6932" y="-158.3" font-family="Times,serif" font-size="14.00" fill="#000000">Plugin</text>
</g>
<!-- Reconstructor&#45;&gt;Plugin -->
<g id="edge5" class="edge">
<title>Reconstructor&#45;&gt;Plugin</title>
<path fill="none" stroke="#000000" d="M95.7269,-216.2022C105.6895,-206.8866 118.0121,-195.3641 128.7306,-185.3416"/>
<polygon fill="#000000" stroke="#000000" points="131.2813,-187.7483 136.1951,-178.3618 126.5004,-182.6353 131.2813,-187.7483"/>
</g>
<!-- Visualizer&#45;&gt;Reconstructor -->
<g id="edge4" class="edge">
<title>Visualizer&#45;&gt;Reconstructor</title>
<path fill="none" stroke="#000000" d="M80.6483,-36.1451C84.0938,-73.7945 84.3536,-160.6409 81.4278,-205.7103"/>
<polygon fill="#000000" stroke="#000000" points="77.9171,-205.7163 80.6391,-215.9555 84.8964,-206.2537 77.9171,-205.7163"/>
</g>
<!-- ... -->
<g id="node6" class="node">
<title>...</title>
<ellipse fill="none" stroke="#000000" cx="146.6932" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="146.6932" y="-86.3" font-family="Times,serif" font-size="14.00" fill="#000000">...</text>
</g>
<!-- Plugin&#45;&gt;... -->
<g id="edge6" class="edge">
<title>Plugin&#45;&gt;...</title>
<path fill="none" stroke="#000000" d="M151.9268,-143.8314C151.1781,-136.131 150.2879,-126.9743 149.4559,-118.4166"/>
<polygon fill="#000000" stroke="#000000" points="152.9347,-118.0276 148.4834,-108.4133 145.9675,-118.7051 152.9347,-118.0276"/>
</g>
<!-- ...&#45;&gt;Visualizer -->
<g id="edge7" class="edge">
<title>...&#45;&gt;Visualizer</title>
<path fill="none" stroke="#000000" d="M131.848,-74.7307C122.8056,-65.4299 111.0406,-53.3288 100.7004,-42.6931"/>
<polygon fill="#000000" stroke="#000000" points="102.9625,-39.9989 93.4822,-35.2687 97.9435,-44.8784 102.9625,-39.9989"/>
</g>
</g>
</svg>

<p>We have the following node types.</p>
<ul>
<li>
<p><strong>Scan Data</strong>. The entry point of the pipeline: data coming from the detector
  which get pushed into the network. This data can also come from simulations or
  be prerecorded.</p>
</li>
<li>
<p><strong>Adapter</strong>. This node is specific to the projection data, and metadata about
  the acquistion. It converts this application specific data, to a common format
  that can be used by nodes further down the pipeline that implement the
  TomoPackets protocol. Some adapter examples can be found in the slicerecon_
  project.</p>
</li>
<li>
<p><strong>Reconstructor</strong>. This node receives projection data and metadata, and uses it
  it to fulfil reconstruction requests from visualization nodes further down the
  line. The slicerecon_ project implements such a node.</p>
</li>
<li>
<p><strong>Plugins</strong>. Plugin nodes take reconstructed slices, and postprocess them. For
  example, for real-time segmentation, artefact removal, other image
  enhancements, or quantitative analysis of the imaged object. If there are no
  active plugins, the reconstructed slice given by the reconstructor is sent
  directly to the visualization node. Example plugins can also be found in the
  slicerecon_ project.</p>
</li>
<li>
<p><strong>Visualizer</strong>. The visualization node shows the reconstructions to a user. When
  the user changes the slices that are being reconstructed, the visualizer
  requests a new reconstruction from the reconstructor. An example visualizer is
  the RECAST3D_ software.</p>
</li>
</ul>
<h2 id="packets">Packets</h2>
<p>A packet is a group of data that has to be sent together. These can be 2D reconstructions, 3D reconstructions, but also slice reconstruction request, and so on. The TomoPackets implementation automates a lot of boilerplate for the developer, and automatically takes care of a lot things such as:</p>
<ul>
<li>Serializing</li>
<li>Deserializing</li>
<li>‘Measuring’</li>
<li>Sending over network</li>
<li>Generating Python bindings with docs.</li>
</ul>
<p>This required some template magic, which luckily is not necessary to understand in order to make new packets.</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span> <span class="n">Packet</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">send</span><span class="p">(</span><span class="n">zmq</span><span class="o">::</span><span class="n">socket_t</span><span class="o">&amp;</span> <span class="n">socket</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">memory_buffer</span> <span class="nf">serialize</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">memory_buffer</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>


<p>TomoPackets is a flexible system, high-performance, easy to extend, and automatically ready to be used in real-time experiments. It abstracts away the whole ‘distributed part’ of the real-time reconstruction pipeline, so that adding features are just as easy as if it was all local. Automatically serialize/deserialize, send over network, and use other languages like Python in the real-time stack. Has built-in servers so that (in principle) clients do not have to rely explicitly on ZeroMQ.</p>
<h3 id="descriptors">Descriptors</h3>
<p>Each packet has a ‘descriptor’, which is a number to identify the content of the packet. The descriptors can be found in <code>descriptors.hpp</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="k">enum</span> <span class="k">class</span> <span class="nc">packet_desc</span> <span class="o">:</span> <span class="kt">int</span> <span class="p">{</span>
   <span class="c1">// SCENE MANAGEMENT</span>
   <span class="n">make_scene</span> <span class="o">=</span> <span class="mh">0x101</span><span class="p">,</span>
   <span class="n">kill_scene</span> <span class="o">=</span> <span class="mh">0x102</span><span class="p">,</span>


   <span class="c1">// RECONSTRUCTION</span>
   <span class="n">slice_data</span> <span class="o">=</span> <span class="mh">0x201</span><span class="p">,</span>
   <span class="n">partial_slice_data</span> <span class="o">=</span> <span class="mh">0x202</span><span class="p">,</span>
   <span class="n">volume_data</span> <span class="o">=</span> <span class="mh">0x203</span><span class="p">,</span>
   <span class="p">...</span>
</code></pre></div>


<h3 id="defining-a-new-packet">Defining a new packet</h3>
<p>A new packet is defined using code such as the following.</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span> <span class="nl">RegularizationParameterPacket</span> <span class="p">:</span> <span class="k">public</span> <span class="n">PacketBase</span><span class="o">&lt;</span><span class="n">RegularizationParameterPacket</span><span class="o">&gt;</span> <span class="p">{</span>
   <span class="k">static</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">packet_desc</span><span class="o">::</span><span class="n">regularization_parameter</span><span class="p">;</span>
   <span class="n">RegularizationParameterPacket</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
   <span class="n">RegularizationParameterPacket</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">a</span><span class="p">,</span> <span class="kt">float</span> <span class="n">b</span><span class="p">)</span> <span class="o">:</span> <span class="n">scene_id</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">lambda</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{}</span>
   <span class="n">BOOST_HANA_DEFINE_STRUCT</span><span class="p">(</span><span class="n">RegularizationParameterPacket</span><span class="p">,</span> <span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">scene_id</span><span class="p">),</span> <span class="p">(</span><span class="kt">float</span><span class="p">,</span> <span class="n">lambda</span><span class="p">));</span>
<span class="p">};</span>
</code></pre></div>


<p>This might seem more complex compared to defining a simple struct, such as:</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span> <span class="nl">RegularizationParameterPacket</span> <span class="p">:</span> <span class="k">public</span> <span class="n">Packet</span> <span class="p">{</span>
    <span class="kt">int32_t</span> <span class="n">scene_id</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">lambda</span><span class="p">;</span>
       <span class="n">packet_desc</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">packet_desc</span><span class="o">::</span><span class="n">regularization_parameter</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p>However, we get a lot in return. Code is automatically generated for networking (serialization, deserialization, measuring, sending, etc.), Python bindings, and the documentation.</p>
<p>We have to perform two additional actions: add ‘regularization_parameter’ to descriptor enum, and optionally add it to the list of packets to expose to Python in <code>tomop/module.cpp</code></p>
<h4 id="serialization">Serialization</h4>
<p>Packets can contain components that are trivially copyable, and <code>std::string</code> (Python strings) and <code>std::vector</code> (Python lists / numpy arrays). </p>
<p>To make a packet with a more exotic component, specialize <code>operator&lt;&lt;</code> and <code>operator&gt;&gt;</code> for <code>memory_span</code> in <code>serialize.hpp</code>.</p>
<h3 id="hierarchy-of-packet-classes-implementation">Hierarchy of packet classes / implementation</h3>
<p>A schematic overview of the relevant classes and funtionality for the packets is as follows.</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (0)
 -->
<!-- Title: G Pages: 1 -->
<svg width="540pt" height="220pt"
 viewBox="0.00 0.00 540.00 220.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 216)">
<title>G</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-216 536,-216 536,4 -4,4"/>
<!-- DerivedPacket -->
<g id="node1" class="node">
<title>DerivedPacket</title>
<polygon fill="none" stroke="#000000" points="149,-212 29,-212 29,-176 149,-176 149,-212"/>
<text text-anchor="middle" x="89" y="-190.3" font-family="Times,serif" font-size="14.00" fill="#000000">DerivedPacket</text>
</g>
<!-- PacketBase -->
<g id="node2" class="node">
<title>PacketBase</title>
<polygon fill="none" stroke="#000000" points="212,-140 0,-140 0,-72 212,-72 212,-140"/>
<text text-anchor="start" x="8" y="-124.8" font-family="Times,serif" font-size="14.00" fill="#000000">PacketBase[DerivedPacket]</text>
<text text-anchor="start" x="75.5" y="-109.8" font-family="Times,serif" font-size="14.00" fill="#006400">serialize</text>
<text text-anchor="start" x="67" y="-94.8" font-family="Times,serif" font-size="14.00" fill="#006400">deserialize</text>
<text text-anchor="start" x="92" y="-79.8" font-family="Times,serif" font-size="14.00" fill="#006400">size</text>
</g>
<!-- DerivedPacket&#45;&gt;PacketBase -->
<g id="edge2" class="edge">
<title>DerivedPacket&#45;&gt;PacketBase</title>
<path fill="none" stroke="#000000" d="M92.5224,-175.7663C93.9639,-168.3045 95.7003,-159.3162 97.44,-150.3106"/>
<polygon fill="#000000" stroke="#000000" points="100.9297,-150.6984 99.3901,-140.216 94.0568,-149.3706 100.9297,-150.6984"/>
</g>
<!-- Packet -->
<g id="node3" class="node">
<title>Packet</title>
<polygon fill="none" stroke="#000000" points="378,-36 314,-36 314,0 378,0 378,-36"/>
<text text-anchor="middle" x="346" y="-14.3" font-family="Times,serif" font-size="14.00" fill="#000000">Packet</text>
</g>
<!-- PacketBase&#45;&gt;Packet -->
<g id="edge3" class="edge">
<title>PacketBase&#45;&gt;Packet</title>
<path fill="none" stroke="#000000" d="M198.7903,-71.9769C235.2912,-58.5932 275.3376,-43.9095 304.435,-33.2405"/>
<polygon fill="#000000" stroke="#000000" points="305.6783,-36.5126 313.8621,-29.7839 303.2685,-29.9404 305.6783,-36.5126"/>
</g>
<!-- omembuf -->
<g id="node4" class="node">
<title>omembuf</title>
<ellipse fill="none" stroke="#000000" cx="284" cy="-106" rx="53.8905" ry="18"/>
<text text-anchor="middle" x="284" y="-102.3" font-family="Times,serif" font-size="14.00" fill="#000000">omembuf</text>
</g>
<!-- omembuf&#45;&gt;Packet -->
<g id="edge6" class="edge">
<title>omembuf&#45;&gt;Packet</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M296.5466,-88.1919C305.3959,-75.6316 317.3995,-58.5942 327.3645,-44.4504"/>
<polygon fill="#000000" stroke="#000000" points="330.3609,-46.2744 333.2592,-36.0837 324.6385,-42.2427 330.3609,-46.2744"/>
</g>
<!-- imembuf -->
<g id="node5" class="node">
<title>imembuf</title>
<ellipse fill="none" stroke="#000000" cx="408" cy="-106" rx="51.9908" ry="18"/>
<text text-anchor="middle" x="408" y="-102.3" font-family="Times,serif" font-size="14.00" fill="#000000">imembuf</text>
</g>
<!-- imembuf&#45;&gt;Packet -->
<g id="edge7" class="edge">
<title>imembuf&#45;&gt;Packet</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M395.4534,-88.1919C386.6041,-75.6316 374.6005,-58.5942 364.6355,-44.4504"/>
<polygon fill="#000000" stroke="#000000" points="367.3615,-42.2427 358.7408,-36.0837 361.6391,-46.2744 367.3615,-42.2427"/>
</g>
<!-- memory_buffer -->
<g id="node6" class="node">
<title>memory_buffer</title>
<polygon fill="none" stroke="#000000" points="417.5,-212 292.5,-212 292.5,-176 417.5,-176 417.5,-212"/>
<text text-anchor="middle" x="355" y="-190.3" font-family="Times,serif" font-size="14.00" fill="#000000">memory_buffer</text>
</g>
<!-- memory_buffer&#45;&gt;omembuf -->
<g id="edge4" class="edge">
<title>memory_buffer&#45;&gt;omembuf</title>
<path fill="none" stroke="#000000" d="M340.2888,-175.7663C329.9667,-162.9729 316.0243,-145.6921 304.5983,-131.5302"/>
<polygon fill="#000000" stroke="#000000" points="307.2112,-129.1948 298.2079,-123.6098 301.7632,-133.5903 307.2112,-129.1948"/>
</g>
<!-- memory_buffer&#45;&gt;imembuf -->
<g id="edge5" class="edge">
<title>memory_buffer&#45;&gt;imembuf</title>
<path fill="none" stroke="#000000" d="M365.9816,-175.7663C373.493,-163.2946 383.5728,-146.5584 391.9769,-132.6044"/>
<polygon fill="#000000" stroke="#000000" points="395.0527,-134.2813 397.2138,-123.9092 389.0562,-130.6698 395.0527,-134.2813"/>
</g>
<!-- fill -->
<g id="node7" class="node">
<title>fill</title>
<ellipse fill="none" stroke="#000000" cx="194" cy="-194" rx="27" ry="18"/>
<text text-anchor="middle" x="194" y="-190.3" font-family="Times,serif" font-size="14.00" fill="#000000">fill</text>
</g>
<!-- fill&#45;&gt;PacketBase -->
<g id="edge1" class="edge">
<title>fill&#45;&gt;PacketBase</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M178.6716,-178.6716C169.9463,-169.9463 158.5566,-158.5566 147.3918,-147.3918"/>
<polygon fill="#000000" stroke="#000000" points="149.6635,-144.7138 140.1176,-140.1176 144.7138,-149.6635 149.6635,-144.7138"/>
</g>
<!-- scale -->
<g id="node8" class="node">
<title>scale</title>
<polygon fill="none" stroke="#000000" points="532,-124 478,-124 478,-88 532,-88 532,-124"/>
<text text-anchor="middle" x="505" y="-102.3" font-family="Times,serif" font-size="14.00" fill="#000000">scale</text>
</g>
<!-- scale&#45;&gt;Packet -->
<g id="edge8" class="edge">
<title>scale&#45;&gt;Packet</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M488.0892,-87.7488C482.3791,-82.234 475.7361,-76.4641 469,-72 443.6862,-55.2242 412.3009,-41.5432 387.5699,-32.1491"/>
<polygon fill="#000000" stroke="#000000" points="388.6959,-28.8337 378.1028,-28.6374 386.2614,-35.3968 388.6959,-28.8337"/>
</g>
</g>
</svg>

<p>Here, solid lines denote inheritence, and dotted lines mean the source is used by the target.</p>
<p>The magic that allows everything to be generated automatically, is the <code>fill</code> function:</p>
<div class="codehilite"><pre><span></span><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Derived</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Buffer</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">fill</span><span class="p">(</span><span class="n">Derived</span><span class="o">&amp;</span> <span class="n">base</span><span class="p">,</span> <span class="n">Buffer</span><span class="o">&amp;</span> <span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">hana</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">hana</span><span class="o">::</span><span class="n">accessors</span><span class="o">&lt;</span><span class="n">Derived</span><span class="o">&gt;</span><span class="p">(),</span>
                  <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span> <span class="n">pair</span><span class="p">)</span> <span class="p">{</span> <span class="n">buffer</span> <span class="o">|</span> <span class="n">hana</span><span class="o">::</span><span class="n">second</span><span class="p">(</span><span class="n">pair</span><span class="p">)(</span><span class="n">base</span><span class="p">);</span> <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>


<p>Every struct for a given functionality (serializing, deserializing and so on) overloads <code>operator|</code>, and this function iteratively calls this operator for each member of the packet. This is also the way the Python bindings are setup. <em>No manual code required</em>.</p>
<h3 id="sending-and-receiving-packets">Sending and receiving packets</h3>
<p>Each packet has a <code>send(socket)</code> function that allows it to be sent over any ZeroMQ socket.</p>
<p>TomoPackets also has a built-in ‘server’. A <code>tomop::server</code> actually runs two independent ‘servers’: one for receiving projections, and one reconstruction server to respond to slice requests This is also where the descriptors come in: anything but <code>packet_desc::set_slice, packet_desc::remove_slice, packet_desc::kill_scene</code> are for example ignored by the ‘reconstruction’ server, while the projection server only listens to <code>packet_desc::projection_data</code>.</p>
<p>You can use: <code>set_slice_callback(callback_type callback)</code> for adding custom reconstruction code and <code>set_projection_callback(projection_callback_type callback)</code> to handle new projections from the scanner.</p>
<p>There is also a ‘multiserver’, which allows connections to more than one visualization tool (RECAST3D).</p>
<p>It is also possible to make custom servers which is what SliceRecon and RECAST3D do:</p>
<ul>
<li>Make a ZeroMQ socket to receive messages</li>
<li>Read the descriptor, and deserialize the message based on the descriptor. After this, handle the packet using its contents.</li>
</ul>
<p>Example code for custom server:</p>
<div class="codehilite"><pre><span></span><code><span class="n">socket_</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">update</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">desc</span> <span class="o">=</span> <span class="p">((</span><span class="n">tomop</span><span class="o">::</span><span class="n">packet_desc</span><span class="o">*</span><span class="p">)</span><span class="n">update</span><span class="p">.</span><span class="n">data</span><span class="p">())[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">switch</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="n">tomop</span><span class="o">::</span><span class="n">packet_desc</span><span class="o">::</span><span class="nl">scan_settings</span><span class="p">:</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">mbuffer</span> <span class="o">=</span> <span class="n">tomop</span><span class="o">::</span><span class="n">memory_buffer</span><span class="p">(</span><span class="n">update</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span>
                                    <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">update</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
  <span class="k">auto</span> <span class="n">packet</span> <span class="o">=</span>
  <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">tomop</span><span class="o">::</span><span class="n">ScanSettingsPacket</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">packet</span><span class="o">-&gt;</span><span class="n">deserialize</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">mbuffer</span><span class="p">));</span>
  <span class="c1">// ...</span>
</code></pre></div>


<h3 id="examples">Examples</h3>
<p>The communication between nodes happens in a using standardized <em>network packets</em>
that contain data, commands, or parameters. Here we give some examples of these
packets.</p>
<h4 id="adapter-to-reconstructor">Adapter to Reconstructor</h4>
<p>The reconstructor needs to receive three types of information from the data
adapter.</p>
<ul>
<li>
<p>Information about where the object is positioned in relation to the
  acquisition geometry. This is done using a
  <code>tomop.geometry_specification_packet</code>, which defines the minimum and
  maximum point of a bounding box around the object, which is the physical
  region to be reconstructed.</p>
</li>
<li>
<p>Information of the acquisition geometry. This is done using either of the
  following four packets.</p>
</li>
<li>
<p><code>tomop.parallel_beam_geometry_packet</code></p>
</li>
<li><code>tomop.parallel_vec_geometry_packet</code></li>
<li><code>tomop.cone_beam_geometry_packet</code></li>
<li>
<p><code>tomop.cone_vec_geometry_packet</code></p>
</li>
<li>
<p>The projection data. This is done using (multiple)
  <code>tomop.projection_packet</code>. The <code>type</code> field of his packet denotes dark
  (<code>0</code>), bright (<code>1</code>), or ordinary (<code>2</code>) projections.</p>
</li>
</ul>
<h4 id="reconstructor-tofrom-visualizer">Reconstructor to/from Visualizer</h4>
<p>The communication between the reconstructor and visualizer uses the following
packets.</p>
<ul>
<li>
<p>To construct a scene, a <code>tomop.make_scene_packet</code> is sent to the
  visualizer. This is done over a <code>REQ/REP</code> channel, the reply is the assigned
  <code>scene_id</code> which can be used to tag later packets.</p>
</li>
<li>
<p>After the scene is constructed, the reconstructor waits to receive
  <code>tomop.set_slice_packet</code> requests.</p>
</li>
<li>
<p>It responds to these packets using a <code>tomop.slice_data_packet</code>. If
  there are plugins active, this packet is sent to the first plugin in line,
  which sends it to the next plugin after it is done processing. The final
  plugin then sends it to the visualizer.</p>
</li>
</ul>
<h4 id="other-uses">Other uses</h4>
<ul>
<li>Plugin system: make a server that reads a SliceDataPacket, modifies it and sends it along the pipeline.
Only necessary change: slice data gets sent to plugin socket instead of RECAST, while plugin forwards it to RECAST</li>
<li>Real-time alignment: e.g. send a control packet ‘rotation_axis’. This creates a slider in RECAST, and the reconstruction software gets notified when the user changes this. 
Can also be used for checkboxes (Gaussian pass, Paganin, &hellip;), 
or drop down menus (changes FBP filter used, …)</li>
<li>Multi-GPU FBP/FDK reconstruction distribute ProjectionDataPackets round robin, and
sum the resulting ‘SliceDataPacket’s at RECAST3D (using the member ‘additive’).</li>
</ul>
<h2 id="conventions">Conventions</h2>
<h3 id="multi-dimensional-arrays">Multi-dimensional arrays</h3>
<ul>
<li>Volume data is stored in x-y-z order (from major to minor).</li>
<li>Projection data is stored in row-column order (from major to minor).</li>
</ul>
<h3 id="slice-orientation">Slice orientation</h3>
<p>We need a convention for representing the orientation of a slice. The
orientation is inside <em>volume space</em> and is completely independent from the
number of pixels (i.e. the &lsquo;size&rsquo; of an individual pixel is implied by the
bounding square of a slice). We represent the orientation as 9 real numbers
<span><span class="MathJax_Preview">(a, b, \ldots, i)</span><script type="math/tex">(a, b, \ldots, i)</script></span> so that:</p>
<div>
<div class="MathJax_Preview">
  \begin{equation}
  \begin{pmatrix}
  a &amp; d &amp; g \\
  b &amp; e &amp; h \\
  c &amp; f &amp; i \\
  0 &amp; 0 &amp; 1
  \end{pmatrix}
  \begin{pmatrix} x_s \\ y_s \\ 1 \end{pmatrix} =
  \begin{pmatrix} x_w \\ y_w \\ z_w \\ 1 \end{pmatrix}
  \end{equation}
</div>
<script type="math/tex; mode=display">
  \begin{equation}
  \begin{pmatrix}
  a & d & g \\
  b & e & h \\
  c & f & i \\
  0 & 0 & 1
  \end{pmatrix}
  \begin{pmatrix} x_s \\ y_s \\ 1 \end{pmatrix} =
  \begin{pmatrix} x_w \\ y_w \\ z_w \\ 1 \end{pmatrix}
  \end{equation}
</script>
</div>
<p>Where the vector <span><span class="MathJax_Preview">\vec{x}_s = (x_s, y_s)</span><script type="math/tex">\vec{x}_s = (x_s, y_s)</script></span> lives inside a slice (i.e. the
<em>normalized</em> pixel coordinates of a slice, in the interval <span><span class="MathJax_Preview">[0, 1]</span><script type="math/tex">[0, 1]</script></span>), and where
<span><span class="MathJax_Preview">\vec{x}_w = (x_w, y_w, z_w)</span><script type="math/tex">\vec{x}_w = (x_w, y_w, z_w)</script></span> lives inside the volume geometry at the correct
place. The pixel coordinates of a slice have the following convention:</p>
<div>
<div class="MathJax_Preview">
  \begin{equation}
  \begin{pmatrix}
  (0, m) &amp; \cdots &amp; (n, m) \\
  \vdots &amp; \ddots &amp; \vdots \\
  (0, 0) &amp; \cdots &amp; (n, 0)
  \end{pmatrix}
  \end{equation}
</div>
<script type="math/tex; mode=display">
  \begin{equation}
  \begin{pmatrix}
  (0, m) & \cdots & (n, m) \\
  \vdots & \ddots & \vdots \\
  (0, 0) & \cdots & (n, 0)
  \end{pmatrix}
  \end{equation}
</script>
</div>
<p>i.e. we start counting from the bottom-left and use a standard cartesian
<span><span class="MathJax_Preview">xy</span><script type="math/tex">xy</script></span> convention.</p>
<p>Using this convention, the vector <span><span class="MathJax_Preview">\vec{b} = (g, h, i)</span><script type="math/tex">\vec{b} = (g, h, i)</script></span> is the base point
of the slice in world space (i.e. the world coordinates of the bottom left point
of a slice). <span><span class="MathJax_Preview">\vec{x} = (a,b,c)</span><script type="math/tex">\vec{x} = (a,b,c)</script></span> is the direction in world space
corresponding to the <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span> direction of the slice, and <span><span class="MathJax_Preview">\vec{y} = (d,
e, f)</span><script type="math/tex">\vec{y} = (d,
e, f)</script></span> corresponds to the <span><span class="MathJax_Preview">y</span><script type="math/tex">y</script></span> direction.</p>
<h3 id="acquisition-geometries">Acquisition geometries</h3>
<p>The fields of the acquisition geometry packets:</p>
<ul>
<li><code>tomop.parallel_beam_geometry_packet</code></li>
<li><code>tomop.parallel_vec_geometry_packet</code></li>
<li><code>tomop.cone_beam_geometry_packet</code></li>
<li><code>tomop.cone_vec_geometry_packet</code></li>
</ul>
<p>follow the conventions of the constructors of 3D Geometries of the ASTRA
Toolbox. See <a href="http://www.astra-toolbox.com/docs/geom3d.html">http://www.astra-toolbox.com/docs/geom3d.html</a> for an overview.</p>
<h2 id="usage">Usage</h2>
<h3 id="writing-a-reconstruction-node">Writing a reconstruction node</h3>
<p>For writing a simple reconstructor that responds to slice reconstruction
requests, you can use <code>tomop.server</code> and set a callback. You can also
send other types of packets over the channel opened by this server. For example,
sending a <code>tomop.volume_data_packet</code> enables a visualizer to show a 3D
preview::</p>
<div class="codehilite"><pre><span></span><code>  <span class="kn">import</span> <span class="nn">tomop</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


  <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">orientation</span><span class="p">,</span> <span class="n">slice_id</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;callback called&quot;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>
                               <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                               <span class="mi">255</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

  <span class="n">serv</span> <span class="o">=</span> <span class="n">tomop</span><span class="o">.</span><span class="n">server</span><span class="p">(</span><span class="s2">&quot;scene name&quot;</span><span class="p">)</span>

  <span class="n">vdp</span> <span class="o">=</span> <span class="n">tomop</span><span class="o">.</span><span class="n">volume_data_packet</span><span class="p">(</span>
      <span class="n">serv</span><span class="o">.</span><span class="n">scene_id</span><span class="p">(),</span>
      <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
      <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span>

  <span class="n">serv</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">vdp</span><span class="p">)</span>

  <span class="n">serv</span><span class="o">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
  <span class="n">serv</span><span class="o">.</span><span class="n">serve</span><span class="p">()</span>
</code></pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../design/" title="Design" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Design
              </span>
            </div>
          </a>
        
        
          <a href="../slicerecon/" title="SliceRecon" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                SliceRecon
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            RECAST3D is licensed under the <a href='https://github.com/cicwi/RECAST3D/blob/master/LICENSE.md'>GPL license</a>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:"../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
        <script src="https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js"></script>
      
    
  </body>
</html>